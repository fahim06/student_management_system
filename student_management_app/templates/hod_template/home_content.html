{% extends 'hod_template/base_template.html' %}
{% block page_title %}
    Home
{% endblock page_title %}
{% block main_content %}

    {% block custom_css %}
        <style>
            .small-box .icon {
                transition: all 0.3s linear;
                position: absolute;
                top: -10px;
                right: 10px;
                z-index: 0;
                font-size: 70px; /* Reduced from 90px for better fit */
                color: rgba(0, 0, 0, 0.15);
            }

            .small-box:hover .icon {
                font-size: 75px; /* Slightly larger on hover */
            }

            .small-box > .small-box-footer {
                z-index: 10; /* Ensure the link is clickable above the icon */
            }

            /* Custom Gradient Backgrounds for Small Boxes */
            .small-box.bg-gradient-blue {
                background: linear-gradient(135deg, #6b85f7 0%, #4a65d8 100%);
                color: #fff;
            }

            .small-box.bg-gradient-green {
                background: linear-gradient(135deg, #58b368 0%, #3d8b4d 100%);
                color: #fff;
            }

            .small-box.bg-gradient-red {
                background: linear-gradient(135deg, #e57373 0%, #d32f2f 100%);
                color: #fff;
            }

            .small-box.bg-gradient-purple {
                background: linear-gradient(135deg, #8e67d6 0%, #6a4fa8 100%);
                color: #fff;
            }
        </style>
    {% endblock custom_css %}

    <main class="app-main" id="main" tabindex="-1">
        <!--begin::App Content-->
        <div class="app-content">
            <!--begin::Container-->
            <div class="container-fluid">
                <!-- Summary Info Boxes -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-gradient-blue">
                            <div class="inner">
                                <h3>{{ student_count }}</h3>
                                <p>Total Students</p>
                            </div>
                            <div class="icon">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <a href="{% url 'manage_student' %}"
                               class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">
                                More Info <i class="bi bi-link-45deg"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-gradient-green">
                            <div class="inner">
                                <h3>{{ staff_count }}</h3>
                                <p>Total Staff</p>
                            </div>
                            <div class="icon">
                                <i class="bi bi-person-badge-fill"></i>
                            </div>
                            <a href="{% url 'manage_staff' %}"
                               class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">
                                More Info <i class="bi bi-link-45deg"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-gradient-red">
                            <div class="inner">
                                <h3>{{ course_count }}</h3>
                                <p>Total Courses</p>
                            </div>
                            <div class="icon">
                                <i class="bi bi-journal-bookmark-fill"></i>
                            </div>
                            <a href="{% url 'manage_course' %}"
                               class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">
                                More Info <i class="bi bi-link-45deg"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-gradient-purple">
                            <div class="inner">
                                <h3>{{ subject_count }}</h3>
                                <p>Total Subjects</p>
                            </div>
                            <div class="icon">
                                <i class="bi bi-stack"></i>
                            </div>
                            <a href="{% url 'manage_subject' %}"
                               class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover">
                                More Info <i class="bi bi-link-45deg"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="row mb-4">
                    <!-- User Distribution Chart -->
                    <div class="col-lg-6">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">User Distribution (Students vs. Staff)</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse"
                                            title="Collapse">
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-remove"
                                            title="Remove">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="donutChart" style="min-height: 250px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Subjects per Course Chart -->
                    <div class="col-lg-6">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Total subject in each course</h3>

                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse"
                                            title="Collapse">
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-remove"
                                            title="Remove">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart">
                                    <div id="courseSubjectChart" style="min-height: 250px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Charts Row 2 -->
                <div class="row mb-4">
                    <!-- Students per Course Chart -->
                    <div class="col-lg-6">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Total student in each course</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse"
                                            title="Collapse">
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-remove"
                                            title="Remove">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="barChart2" style="min-height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Pie Chart for Students per Subject -->
                    <div class="col-lg-6">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Total Student in Each Subject</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse"
                                            title="Collapse">
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-remove"
                                            title="Remove">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="subjectStudentPieChart" style="min-height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Charts Row 3 -->
                <div class="row mb-4">
                    <!-- Staff Attendance and Leave Bar Chart -->
                    <div class="col-lg-12">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Staff Attendance vs. Leave</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse"
                                            title="Collapse">
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-remove"
                                            title="Remove">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart">
                                    <div id="staffAttendanceChart" style="min-height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Charts Row 4 -->
                <div class="row mb-4">
                    <!-- Student Attendance and Leave Bar Chart -->
                    <div class="col-lg-12">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Student Attendance vs. Leave</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse"
                                            title="Collapse">
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-remove"
                                            title="Remove">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart">
                                    <div id="studentAttendanceChart" style="min-height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--end::Container-->
        </div>
        <!--end::App Content-->
    </main>

{% endblock main_content %}

{% block custom_js %}
    <script
            src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"
            integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8="
            crossorigin="anonymous">

    </script>
    <script>
        /**
         * This script initializes all ApexCharts on the HOD dashboard.
         * It uses a helper function to reduce code duplication and ensures
         * each chart's initialization is isolated to prevent a single failure
         * from breaking all other charts.
         */
        document.addEventListener("DOMContentLoaded", function () {

            /**
             * A generic helper function to render an ApexChart.
             * @param {string} selector - The CSS selector for the chart's container element.
             * @param {object} options - The ApexCharts configuration object.
             * @param {function} [dataCheck] - An optional function that returns true if data is missing.
             * @param {string} [noDataMessage='No data to display.'] - The message to show if data is missing.
             */
            const renderChart = (selector, options, dataCheck, noDataMessage = 'No data to display.') => {
                const chartEl = document.querySelector(selector);
                if (!chartEl) return; // Exit if the chart container doesn't exist

                if (dataCheck && dataCheck()) {
                    chartEl.innerHTML = `<p class="text-center text-muted">${noDataMessage}</p>`;
                    return;
                }

                new ApexCharts(chartEl, options).render();
            };

            // Chart 1: Student and Staff Donut Chart
            (() => {
                const studentCount = {{ student_count|default:0 }};
                const staffCount = {{ staff_count|default:0 }};

                const chartOptions = {
                    series: [studentCount, staffCount],
                    chart: {
                        type: 'donut',
                        height: 260
                    },
                    labels: ['Students', 'Staffs'],
                    colors: ['#58b368', '#e57373'],
                    plotOptions: {
                        pie: {
                            donut: {
                                labels: {
                                    show: true,
                                    total: {
                                        show: true, // Show the total in the center
                                        label: 'Total Users', // The text label for the total
                                        formatter: (w) => w.globals.seriesTotals.reduce((a, b) => a + b, 0) // The function to calculate the total
                                    }
                                }
                            }
                        }
                    },
                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {width: 200},
                            legend: {position: 'bottom'}
                        }
                    }]
                };

                renderChart('#donutChart', chartOptions, () => studentCount === 0 && staffCount === 0);
            })();

            // Chart 2: Subjects per Course Bar Chart
            (() => {
                const courseNames = {{ course_name_list|default:'[]'|safe }};
                const subjectCounts = {{ subject_cont_list|default:'[]'|safe }};

                const chartOptions = {
                    chart: {type: 'bar', height: 250, toolbar: {show: false}},
                    series: [{name: 'Number of Subjects', data: subjectCounts}],
                    colors: ['#6b85f7'],
                    legend: {position: 'top', showForSingleSeries: true},
                    plotOptions: {
                        bar: {horizontal: false, columnWidth: '55%'}
                    },
                    dataLabels: {enabled: false},
                    stroke: {show: true, width: 2, colors: ['transparent']},
                    xaxis: {categories: courseNames, title: {text: 'Courses'}},
                    yaxis: {
                        title: {text: 'Number of Subjects'},
                        labels: {formatter: (val) => parseInt(val)}
                    },
                    fill: {opacity: 1},
                };

                renderChart('#courseSubjectChart', chartOptions, () => !courseNames || courseNames.length === 0, 'No course/subject data to display.');
            })();

            // Chart 3: Students per Course Bar Chart
            (() => {
                const courseNames = {{ course_name_list|default:'[]'|safe }};
                const studentCounts = {{ student_count_list_in_course|default:'[]'|safe }};

                const chartOptions = {
                    series: [{
                        name: 'Number of Students',
                        data: studentCounts
                    }],
                    chart: {
                        type: 'bar',
                        height: 250,
                        toolbar: {
                            show: false
                        }
                    },
                    colors: ['#58b368'],
                    legend: {position: 'top', showForSingleSeries: true},
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '55%',
                        },
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        show: true,
                        width: 2,
                        colors: ['transparent']
                    },
                    xaxis: {
                        categories: courseNames,
                        title: {
                            text: 'Courses'
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Number of Students'
                        },
                        labels: {
                            formatter: (val) => parseInt(val)
                        },
                    },
                    fill: {
                        opacity: 1
                    },
                };

                renderChart('#barChart2', chartOptions, () => !courseNames || courseNames.length === 0, 'No student/course data to display.');
            })();

            // Chart 4: Students per Subject Pie Chart
            (() => {
                const subjectNamesForPie = {{ subject_list_for_pie_chart|default:'[]'|safe }};
                const studentCountsInSubject = {{ student_count_in_subject_for_pie_chart|default:'[]'|safe }};

                const chartOptions = {
                    series: studentCountsInSubject,
                    chart: {type: 'pie', height: 260},
                    labels: subjectNamesForPie,
                    legend: {position: 'right'},
                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {width: 200},
                            legend: {position: 'right'}
                        }
                    }]
                };

                renderChart('#subjectStudentPieChart', chartOptions, () => !subjectNamesForPie || subjectNamesForPie.length === 0, 'No student/subject data to display.');
            })();

            // Chart 5: Staff Attendance and Leave Bar Chart
            (() => {
                const staffNames = {{ staff_name_list|default:'[]'|safe }};
                const attendanceCounts = {{ attendance_present_list_staff|default:'[]'|safe }};
                const leaveCounts = {{ attendance_absent_list_staff|default:'[]'|safe }};

                const chartOptions = {
                    series: [{
                        name: 'Attendance',
                        data: attendanceCounts
                    }, {
                        name: 'Leave',
                        data: leaveCounts
                    }],
                    chart: {
                        type: 'bar',
                        height: 350,
                        stacked: false, // Set to false for grouped bars
                        toolbar: {
                            show: true
                        },
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '60%',
                        },
                    },
                    xaxis: {
                        categories: staffNames,
                        title: {
                            text: 'Staff'
                        }
                    },
                    yaxis: {
                        title: {text: 'Number of Days'}
                    },
                    legend: {
                        position: 'top',
                    },
                    fill: {
                        opacity: 1
                    },
                    colors: ['#58b368', '#e57373'], // Green for Attendance, Red for Leave
                };

                renderChart('#staffAttendanceChart', chartOptions, () => !staffNames || staffNames.length === 0, 'No staff attendance data to display.');
            })();

            // Chart 6: Student Attendance and Leave Bar Chart
            (() => {
                const studentNames = {{ student_name_list|default:'[]'|safe }};
                const attendanceCounts = {{ attendance_present_list_student|default:'[]'|safe }};
                const leaveCounts = {{ attendance_absent_list_student|default:'[]'|safe }};

                const chartOptions = {
                    series: [{
                        name: 'Attendance',
                        data: attendanceCounts
                    }, {
                        name: 'Leave',
                        data: leaveCounts
                    }],
                    chart: {
                        type: 'bar',
                        height: 350,
                        stacked: false, // Set to false for grouped bars
                        toolbar: {
                            show: true
                        },
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '60%',
                        },
                    },
                    xaxis: {
                        categories: studentNames,
                        title: {
                            text: 'Students'
                        }
                    },
                    yaxis: {
                        title: {text: 'Number of Days'}
                    },
                    legend: {
                        position: 'top',
                    },
                    fill: {
                        opacity: 1
                    },
                    colors: ['#58b368', '#e57373'], // Green for Attendance, Red for Leave
                };

                renderChart('#studentAttendanceChart', chartOptions, () => !studentNames || studentNames.length === 0, 'No student attendance data to display.');
            })();
        });
    </script>
{% endblock custom_js %}